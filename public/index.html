<!DOCTYPE html>
<html>
<head>
    <title>لوحة تحكم التطبيق</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; }
        input, button, select { display: block; margin-bottom: 10px; padding: 10px; width: 100%; box-sizing: border-box; }
        #status { font-weight: bold; }

        /* ⬇️⬇️ ستايل شريط التحميل ⬇️⬇️ */
        #progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
            display: none; /* إخفاؤه في البداية */
        }
        #progress-bar {
            width: 0%;
            height: 30px;
            background-color: #4CAF50;
            text-align: center;
            line-height: 30px;
            color: white;
            border-radius: 5px;
        }
        /* ⬆️⬆️ نهاية ستايل شريط التحميل ⬆️⬆️ */
    </style>
</head>
<body>
    <h2>لوحة تحكم تحديث التطبيق</h2>
    
    <form id="uploadForm">
        <label>ملف APK الجديد:</label>
        <input type="file" id="apkFile" name="apkFile" accept=".apk" required />
        
        <label>رقم الإصدار (Code - مثل 2, 3, 4):</label>
        <input type="number" id="versionCode" name="versionCode" placeholder="2" required />
        
        <label>اسم الإصدار (Name - مثل 1.0.1):</label>
        <input type="text" id="versionName" name="versionName" placeholder="1.0.1" required />

        <label>كلمة المرور (Secret):</label>
        <input type="password" id="secret" name="secret" placeholder="كلمة المرور السرية" required />
        
        <button type="submit">نشر التحديث</button>
    </form>
    
    <div id="progress-container">
        <div id="progress-bar">0%</div>
    </div>
    
    <p id="status">الحالة: في انتظار الرفع...</p>

    <script type="module">
        // استيراد الدالة 'upload' من CDN
        import { upload } from 'https://unpkg.com/@vercel/blob@0.23.3/dist/client.js';

        const form = document.getElementById('uploadForm');
        const statusEl = document.getElementById('status');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const submitButton = form.querySelector('button');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const file = document.getElementById('apkFile').files[0];
            const vCode = document.getElementById('versionCode').value;
            const vName = document.getElementById('versionName').value;
            const secret = document.getElementById('secret').value;

            if (!file) {
                statusEl.innerText = "يرجى اختيار ملف أولاً";
                return;
            }

            statusEl.innerText = "جاري بدء الرفع...";
            statusEl.style.color = "blue";
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.innerText = '0%';
            submitButton.disabled = true; // تعطيل الزر أثناء الرفع

            try {
                // 2. بدء الرفع مباشرة إلى Blob
                const blob = await upload(
                    file.name, // اسم الملف
                    file,      // الملف نفسه
                    {
                        access: 'public',
                        // رابط الـ API الذي سيعطي الإذن
                        handleUploadUrl: '/api/upload', 
                        
                        // 3. إرسال البيانات الإضافية (كلمة المرور، الإصدار)
                        // الـ API سيستقبلها في دالة 'beforeUpload'
                        body: JSON.stringify({
                            versionCode: vCode,
                            versionName: vName,
                            secret: secret,
                        }),
                        
                        // 4. هذا هو مؤشر التحميل الذي طلبته
                        onUploadProgress: (progress) => {
                            const percent = Math.round(progress);
                            progressBar.style.width = percent + '%';
                            progressBar.innerText = percent + '%';
                            statusEl.innerText = `جاري الرفع... ${percent}%`;
                        },
                    }
                );

                // تم الرفع بنجاح
                statusEl.innerText = `تم النشر بنجاح! الإصدار: ${vName}`;
                statusEl.style.color = "green";
                form.reset();

            } catch (error) {
                console.error(error);
                statusEl.innerText = "حدث خطأ: " + error.message;
                statusEl.style.color = "red";
            } finally {
                // إعادة تفعيل الزر وإخفاء الشريط عند الانتهاء أو الفشل
                submitButton.disabled = false;
                // لا تخفي الشريط عند النجاح ليرى المستخدم النتيجة
                // progressContainer.style.display = 'none'; 
            }
        });
    </script>
</body> 
</html>